package main

import (
	"context"

	"github.com/fredrikaverpil/sage-ci/config"
	"github.com/fredrikaverpil/sage-ci/targets"
	"go.einride.tech/sage/sg"
)

// cfg defines the project-specific configuration for sage-ci.
// Customize this to match your project structure.
var cfg = config.Config{
	// GoModules lists the Go module paths relative to the repository root.
	// Example: []string{".", "tools"}
	GoModules: []string{},

	// PythonModules lists the Python module paths relative to the repository root.
	// Example: []string{".", "scripts"}
	PythonModules: []string{},

	// LuaModules lists the Lua module paths relative to the repository root.
	// Example: []string{".", "plugins"}
	LuaModules: []string{},

	// Platform specifies which CI platform to generate workflows for.
	// Options: "github", "gitlab", "codeberg"
	// Default: "github"
	Platforms: []config.Platform{config.PlatformGitHub},

	// Skip lists workflow names to skip during sync.
	// Example: []string{"lint", "test"}
	SkipWorkflows: []string{},

	// SkipTargets lists sage target names to skip.
	// Key: Target name (e.g. "GoTest").
	// Value: List of modules to skip. Use "*" to skip all modules.
	// Example: config.SkipTargets{"GoLint": {"tools"}}
	SkipTargets: config.SkipTargets{},
}

func main() {
	sg.GenerateMakefiles(
		sg.Makefile{
			Path:          sg.FromGitRoot("Makefile"),
			DefaultTarget: All,
		},
	)
}

// All is the default target. Customize this to run the targets you need.
func All(ctx context.Context) error {
	targets.RunSerial(ctx, cfg)
	targets.RunParallel(ctx, cfg)
	return targets.GitDiffCheck(ctx)
}

// GenerateWorkflows regenerates CI workflows for the configured platform.
func GenerateWorkflows(ctx context.Context) error {
	return targets.GenerateWorkflows(cfg)
}

// UpdateSageCi updates the sage-ci dependency and regenerates Makefiles and workflows.
func UpdateSageCi(ctx context.Context) error {
	return targets.UpdateSageCi(ctx, cfg)
}
